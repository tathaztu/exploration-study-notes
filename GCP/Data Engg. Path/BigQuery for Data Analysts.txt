Use BigQuery ↦ Data Analysis

BigQuery ⇒ Data
    •   Ingest
    •   Transform
    •   Query
    -   Derive Insights ↦ Business Decision making

○   Analytics challenges faced by data analysts
○   Big data on Prem. vs. Cloud


○   SQL ↦ Querying, Clean + Prepare + Transform data
○   Principles about data integrity

Other tools for Data Prep. And Transformation
    •   Data Prep
    •   Cloud Data Fusion
    •   Data Flow
    •   Data Proc
    •   Data Form that can help with

○   Ingesting & Storing data into Big Query Native Storage
    a. Extract & Load vs. Extract Load
    b. Transform vs. Extract Transform & Load
○   External Data Sources
○   Visualize Insights from your Data
    a. Visualization Theory
    b. Best practices
    c. Tools
        • Looker studio
        • Connected sheets
    d. Allos SQL
    e. Python, Java, R | Jupiter Notebooks
○   Data form → Version Control and Orchestrate SQL pipelines
○   Big Query Studio → End-2-End Analytics | Single purpose-built platform
○   Demo and a Hands-On lab


╭───────────────────────────────╮
│  Common Analytics Challenges  │
╰───────────────────────────────╯

• Major Users of Data
    ○ Data Analysts
        - Gather & Interpret data ⇒ Problems | Decisions
        - SQL + Static Modeling
        - Summarize Data, Reports & Visualizations, Insights
    ○ Data Engineers
        - Collect + Validate + Prep.
        - Data Pipelines
    ○ Data Scientists
        - Dynamic Techniques, e.g. ML, ⇒ Insights about the future
• Data Analysts, Engineers & Scientists may
    ○ Work together
    ○ Be the same person

Challenges faced by Data Analysts (and others)
—————————————————————————————————
• What?
    ○ Too much Data
    ○ Disconnected Data
• Why?
    ○ Queries:          Slow | Complicated
    ○ Infrastructure:   Scalability, maintenance, etc.
    ○ Storage:          Capacity | Pricing | Decentralized data

• Other requirements
    ○ Compute | Network | Hardware
    ○ Software & Licenses

• Querying in the huge volume of data

• Major T&M expenditure in most Big Data Projects is spent on the care and
feeding of the machinery
    ○ Managing Infrastructure
    ○ Manipulating Data
    ○ Monitoring
    ○ Performance

• Advantages of Google Cloud
    ○ # Regions & Zones → continually increasing
    ○ edge points of presence
        - Locations where Google Networks are connected with ISPs
        - Allows very low-latency network performance
        - Scaling up and down is automatic

• Key feature → decoupling of storage and compute power.
• Big Query - Uses Storage, Compute, Network, Scalability, etc.
• BigQuery ↦ Google Cloud | Fully Managed | Enterprise Data Warehouse
• Serverless Architecture → Fire SQL Queries → Zero infrastructure management
• Scalable, Distributed Analysis Engine → Query Terabytes⇐sec + Petabytes⇐min
• Compute Engine separate from Storage





TODO TODO TODO - Other chapters





╭───────────────────────────────────────╮
│  Cleaning and Transforming your Data	│
╰───────────────────────────────────────╯

Module Overview
	○ Mostly uses SQL and Data-Prep tools
	○ Visualization tools are useful for this purpose as well

5 principles of dataset integrity
	•	High-quality datasets will yield high-quality insights
		Garbage In ⇒ Garbage Out
	•	5 qualities of good data
		○	Valid: Conform → Business Rules
		○ 	Accurate: Conform → True objective value
		○	Complete: 
			▪	Whole picture → 
			▪	Not just a subset → 
			▪	Unfiltered
			▪	Not Truncated
			▪	No Loss
		○	Consistent: 
			▪	Harmony across Data Systems
			▪	No contradictory facts
		○	Uniform

	➤	Validity
		Using Constraints
			▪	Data-Type
			▪	Range			- Conditionals: CASE WHEN IF THEN ELSE
			▪	Mandate			- Nullable, Required | Null vs. Blank
			▪	Set-Membership
			▪	Foreign-Key
			▪	RegEx Patterns
			▪	Cross-Field
			▪	Uniqueness
	➤	Accuracy
		•	Subjective
		•	"gold standard" data is often unavailable
		
		Calculations
			▪	e.g. SELECT (quantity_ordered * item_price) AS sub_total
		Lookup a Reference Dataset
			▪	e.g. IN() with a subquery or CTE or JOIN
	➤	Completeness
		• 	Questioning the source
		• 	Check Skewness, Null Values, 
		• 	Mash with other Datasets
	➤	Consistency
		•	2 or more data items in the data set contradict each other
		•	Not always possible
		
		Parsing Dates, SUBSTRING, REPLACE
	➤	Uniform

		Using 
		•	FORMAT and CAST
		•	DATE(), TIME(), and DATETIME()
		•	Convert Unix Epoch time values
		• 	Check for NULL and blanks
Dataset Shapes
——————————————
Wide but Short		╎ 	Lot of columns 	| Fewer Rows
Taller than Wide	╎	Lot of Rows		| Few columns
Small				╎	Avg. # Rows		| Avg. # Cols
Perfect				╎	Right # Rows	| Right # Cols

Dataset Skew 

Skew: Distribution of values
	Examples
	• Too much data for a particular entity
	• Data is based on only one entity

	Analysis Tools
	• GROUP BY and ORDER BY 
	• Validate with Real World Facts
	
┌───────────────┐
│  Other Tools	│
└───────────────┘

Cloud Data Fusion + Wrangler tool
Dataflow	- Code 
Dataprep 	- UI based 
Dataproc	- ETL 
Dataform	- Available through the BigQuery console,

When to use which product.


Cloud Data Fusion
‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
	• [Fully Managed + Cloud Native] Enterprise data integration service 
	• Quick Build + Manage data pipelines
	• GUI | No-Code
	• Audience: Business users, developers, data analysts, and scientists 
	• Quickly + Easily - Build, Deploy, & Manage Data Integration Pipelines

	• Scenarios: 
		○ Not all data can be exported to Excel and Sheets
		○ Inconsistent metadata and no business glossary
		○ Operationalizing the data preparation is a challenge 
	
	Wrangler:
		○ Powerful tool in Cloud Data Fusion 
		○ View, explore, and create data transformations 
		○ Transform a small sample (10 MB) of your data in one place before 
		running the logic on the entire dataset
		○ Easy and Interactive way to visualize, transform, and cleanse data
		○ View data from multiple locations - Cloud Storage, Kafka, DB, etc.
		○ Derive new schemas and operationalize the data prep with a few clicks.

		- Connect to your data wherever it resides, and transform it using 
		simple, point-and-click transformation steps.
		- Create multiple transformations and add them to a recipe. 
		- Create a data pipeline based on the best suited recipe - including the 
		source and the Wrangler transformation
		- Add more plugins in the UI to continue transforming your data and add 
		a sink to write the transformed data to a target location like BigQuery.

Dataflow
‾‾‾‾‾‾‾‾
Google Cloud service → Unified Stream + Batch data processing, ETL, at scale.
* ETL: Extract, Transform and Load 

Pipeline model - Data moves through a series of stages.
	• Reading data from a source
	• Transforming and aggregating 
	• Writing the results to a destination.
Pipelines → Very simple to Complex processing.
	• Move data as-is to a destination.
	• Transform data to be more useable by the target system.
	• Aggregate, process, and enrich data for analysis.
	• Join data with other data.
Based on the open source Apache Beam project.
	• Open source, unified model ⇒ Define ⇒ batch and streaming pipelines.
	• Simplifies the mechanics of large-scale data processing.
	• Using Apache Beam SDKs → 
		- Build a program that defines the pipeline.
		- Execute the pipeline on a specific platform such as Dataflow.
Model lets you focus on the 
	• Logical composition of data processing job, rather than managing the 
	orchestration of parallel processing.

Apache Beam → Abstracts low-level details of distributed processing - 
coordinating individual workers, sharding datasets, etc.
→ Dataflow fully manages these low-level details.

A pipeline can be run 
	• Locally on your computer
	• Remotely on a VM
	• Another service in the cloud.

Runner
	→ Specifies the engine that will be powering your pipeline
	→ Specific Configuration + An associated backend service
	Dataflow is one of the runners available in Apache Beam.


Dataprep
‾‾‾‾‾‾‾‾
• Integrated partner service | Operated by Trifacta (third party)
• Built on Dataflow → Auto-scalable | Easily process massive datasets
• Fully integrated w. Google Cloud  | No infrastructure deploy/manage.
• Access raw data from BigQuery, Cloud Storage, or local files ⇐ CSV, JSON, or 
a Relational table format.
• Refined data can be directly ported into BigQuery, Looker Studio, Cloud 
Storage, or Vertex AI for further analysis and storage.
• Dataprep easily scales to handle any data size, to execute transformations, 
by using the power of Cloud Dataflow to execute efficiently and in any region supported by Google Cloud.

Common use cases
Data onboarding: 
	Integrate external or third-party information into their work
	Need to ensure that it conforms to internal structures and formats 
Data science and machine learning: 
	Clean, well-structured data to effectively train models.
Marketing analytics: 
	Google Cloud users have access to tons of marketing data
	Gaining insight → combining & enriching that data with a range of datasets
	from cross functional sources like sales, finance, or support.
	This can involve manipulating those datasets into forms that can be joined, 
	aggregated, and cleansed.
	Dataprep is a graphical user interface (GUI) for creating data 
	transformation steps.
	You can pick from predefined wranglers to process your data.

	Review the final data flow and then run the job, which will then kick off a
	new Dataflow job behind the scenes.
	Use dashboards to monitor your jobs, and dig into the metrics for your 
	transformed datasets.


Dataproc
‾‾‾‾‾‾‾‾
	• Fully managed and highly scalable service 
	• Purpose-Built Cluster
	• Run
		○ Apache Hadoop
		○ Apache Spark
		○ Apache Flink
		○ Presto
		○ 30+ open source tools and frameworks
	• Use for cost effective 
		○ Data lake modernization
		○ ETL
		○ Secure data science, at scale, integrated with Google Cloud
	• Data or Analytics processing jobs
	• Built-in integration with other Google Cloud Platform services - 
		○ BigQuery
		○ Cloud Storage
		○ Cloud Bigtable
		○ Cloud Logging
		○ Cloud Monitoring

		- e.g. Effortlessly ETL terabytes of raw log data directly into BigQuery
		for business reporting.



Summary.

Cloud Data Fusion (and its Wrangler tool) and Dataprep come with a graphical user interface that can help with the wrangling activities.

With Dataflow, you have more flexibility because you can code all your transformations, but that means that you will need to do quite a bit of coding.

Dataproc is a managed Spark and Hadoop service that lets you take advantage of 
open source data tools for batch processing, querying, streaming, and machine 
learning.

Dataform helps you develop and operationalize scalable data transformation 
pipelines in SQL, and we will cover that in a later module.


╭───────────────────────────────────────────────╮
│  Ingesting + Storing New BigQuery Datasets	│
╰───────────────────────────────────────────────╯


Permanant & Temporary

Temporary - Specified or Default

Temporary - 24hrs

Query Cache → Temporary Table
	Same queries →  will use cached results in the near future when available
	Assuming: 
		The underlying table has not been modified
		No use of nondeterministic functions like CURRENT DATE, etc
View
	○ 	Virtual table that's defined by a SQL query
	○	It is essentially a SELECT statement
	○	Defining Query run each time the view is queried
	○	Does not store the results
	○	Queried using:
		a. Web UI
		b. Command-line tool
		c. API
	○	Queries billed → Total amount of data in all table fields → referenced 
	directly or indirectly by the top-level query.
	○ 	DDLs
	
		CREATE VIEW		╎ Query to be saved as a view.
		OR REPLACE 		╎ Overwrite the view query, if one already exists 
		IF NOT EXISTS 	╎ Create the view only if not exists
	
Materialized Views
Periodically cache the results of a query
	• BigQuery used Precomputed Results in the Materialized Views
	• Reads only delta changes from the base table to compute up-to-date results
	•💡Queries that use materialized views are generally faster and consume 
	fewer resources than queries that retrieve the same data only from the base 
	table.
	• Grant access at the Dataset level, the View level, or the COLUMN level.
	• set access at a higher level in the IAM resource hierarchy.
	• Manually refresh a materialized view at any time
	• 👉 Partition a materialized view if the base table is partitioned as well.
	• Automatically refreshed within 5 minutes of a change to the base table, 
	but no more frequently than every 30 minutes.


❓The table suffix 20170801 is automatically partitioned by day. If we created 
more tables for other days, the all_sessions_raw_(N) would increment by N 
distinct days of data. There is another lab that explores different ways of 
partitioning your data tables.


CREATE OR REPLACE TABLE ecommerce.revenue_transactions_20170801
(
  fullVisitorId STRING NOT NULL OPTIONS(description="Unique visitor ID"),
  visitId STRING NOT NULL OPTIONS(description="Visit ID"),
  channelGrouping STRING NOT NULL OPTIONS(description="Channel e.g. Direct, Organic, Referral..."),
  totalTransactionRevenue FLOAT64 OPTIONS(description="Revenue * 10^6 for the transaction")
)
as
select DISTINCT
	fullVisitorId,
	visitId,
	channelGrouping,
	totalTransactionRevenue/1000000
from `data-to-insights.ecommerce.all_sessions_raw table`
where totalTransactionRevenue is not null
and date = '20170801'




An external data source is a data source that can be queried directly from 
BigQuery, even though the data is not stored in BigQuery storage
	• Federated Queries
	• External Tables
	
	○ Ad-hoc queries where performance is not an issue.
	○ Accessing ⇒ short term, less-frequently accessed data.
	○ Accessing ⇒ constantly changing data (like from a Google sheet).
	○ Joining BigQuery tables with frequently changing data from an external 
	data source.

💡By querying the external data source directly, you don't need to reload the 
data into BigQuery storage every time it changes.
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































